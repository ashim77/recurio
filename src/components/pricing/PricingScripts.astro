<script type="module">
	const page = document.querySelector('[data-pricing-page]');
	if (!page) {
		throw new Error('Pricing page root not found.');
	}

	const errorBox = page.querySelector('[data-checkout-error]');
	const errorText = page.querySelector('[data-checkout-error-text]');
	const successBox = page.querySelector('[data-checkout-success]');
	const buttons = page.querySelectorAll('[data-checkout]');
	const faqButtons = page.querySelectorAll('[data-faq-button]');

	const storeId = import.meta.env.VITE_LEMONSQUEEZY_STORE_ID || '';
	const variants = {
		starter: import.meta.env.VITE_LEMONSQUEEZY_STARTER_VARIANT_ID || '',
		professional: import.meta.env.VITE_LEMONSQUEEZY_PROFESSIONAL_VARIANT_ID || '',
		agency: import.meta.env.VITE_LEMONSQUEEZY_AGENCY_VARIANT_ID || ''
	};

	const setError = (message) => {
		if (errorBox && errorText) {
			errorText.textContent = message;
			errorBox.classList.remove('hidden');
		}
		if (successBox) {
			successBox.classList.add('hidden');
		}
	};

	const clearError = () => {
		if (errorBox) {
			errorBox.classList.add('hidden');
		}
	};

	const setButtonLoading = (button, isLoading) => {
		const defaultLabel = button.querySelector('[data-checkout-default]');
		const loadingLabel = button.querySelector('[data-checkout-loading]');
		if (isLoading) {
			button.setAttribute('disabled', 'disabled');
			if (defaultLabel) {
				defaultLabel.classList.add('hidden');
			}
			if (loadingLabel) {
				loadingLabel.classList.remove('hidden');
				loadingLabel.classList.add('inline-flex');
			}
		} else {
			button.removeAttribute('disabled');
			if (defaultLabel) {
				defaultLabel.classList.remove('hidden');
			}
			if (loadingLabel) {
				loadingLabel.classList.add('hidden');
				loadingLabel.classList.remove('inline-flex');
			}
		}
	};

	const buildCheckoutUrl = (variantId) => {
		return `https://checkout.lemon.squeezy.com/checkout/buy/${variantId}?embed=1&media=0`;
	};

	const openOverlay = (url, onClose) => {
		const overlay = document.createElement('div');
		overlay.className = 'fixed inset-0 z-50 bg-slate-900/60 flex items-center justify-center p-4';
		overlay.innerHTML = `
			<div class="relative w-full max-w-3xl h-[80vh] bg-white rounded-2xl shadow-2xl overflow-hidden">
				<button type="button" class="absolute right-4 top-4 z-10 text-slate-500 hover:text-slate-700" data-overlay-close>
					<svg viewBox="0 0 24 24" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M18 6 6 18"/><path d="m6 6 12 12"/>
					</svg>
				</button>
				<iframe class="w-full h-full" src="${url}" title="Checkout"></iframe>
			</div>
		`;

		const close = () => {
			overlay.remove();
			onClose();
		};

		overlay.addEventListener('click', (event) => {
			if (event.target === overlay) {
				close();
			}
		});

		overlay.querySelector('[data-overlay-close]')?.addEventListener('click', close);
		document.addEventListener(
			'keydown',
			(event) => {
				if (event.key === 'Escape') {
					close();
				}
			},
			{ once: true }
		);

		document.body.appendChild(overlay);
	};

	let activeButton = null;

	buttons.forEach((button) => {
		button.addEventListener('click', (event) => {
			event.preventDefault();
			clearError();

			const planId = button.dataset.checkout;
			if (!planId) {
				setError('Plan not found.');
				return;
			}

			if (!storeId) {
				setError('Payment system not configured. Please set VITE_LEMONSQUEEZY_STORE_ID in your .env file.');
				return;
			}

			const variantId = variants[planId];
			if (!variantId) {
				setError(`Variant ID not configured for ${planId}. Please add it to your .env file.`);
				return;
			}

			if (activeButton) {
				setButtonLoading(activeButton, false);
			}

			activeButton = button;
			setButtonLoading(button, true);

			const url = buildCheckoutUrl(variantId);
			openOverlay(url, () => {
				setButtonLoading(button, false);
				activeButton = null;
			});
		});
	});

	faqButtons.forEach((button) => {
		const panel = button.parentElement?.querySelector('[data-faq-panel]');
		if (!panel) {
			return;
		}

		button.addEventListener('click', () => {
			const isOpen = button.getAttribute('aria-expanded') === 'true';
			button.setAttribute('aria-expanded', (!isOpen).toString());
			panel.classList.toggle('hidden', isOpen);
		});
	});

	const url = new URL(window.location.href);
	if (url.searchParams.get('checkout') === 'success' && successBox) {
		successBox.classList.remove('hidden');
	}
</script>
